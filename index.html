<!DOCTYPE html>
<html lang="fi">
<head>
<meta charset="UTF-8" />
<title>Aulan näyttö – Tapahtumat • Sää • Tilannehuone</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<style>
  :root{
    --gap: 16px;
    --panel-pad: 16px;
    --header-h: 64px;
    --accent: #007b83;
    --slide-time-ms: 20000;
  }
  html,body{
    margin:0;height:100vh;width:100vw;background:#e9eef3;color:#111;
    font-family:"Segoe UI",Tahoma,Verdana,sans-serif;overflow:hidden;
    -webkit-text-size-adjust:100%;
    touch-action: manipulation;
  }
  #clock{
    position:fixed;top:10px;right:16px;font-size:1.1rem;font-weight:700;
    background:rgba(0,0,0,.6);color:#fff;padding:6px 10px;border-radius:8px;z-index:10
  }

  /* SLIDES */
  .slides{height:100%;width:100%;position:relative}
  .slide{
    position:absolute;inset:0;background:#fff;border-radius:16px;box-shadow:0 6px 20px rgba(0,0,0,.15);
    display:grid;grid-template-rows:var(--header-h) 1fr;overflow:hidden;opacity:0;pointer-events:none;transform:scale(.985);
    transition:opacity .35s ease, transform .35s ease;margin:var(--gap);
    -webkit-tap-highlight-color: transparent;
  }
  .slide.active{opacity:1;pointer-events:auto;transform:scale(1)}
  .slide-header{
    display:flex;align-items:center;justify-content:center;font-weight:800;font-size:1.5rem;color:#fff;background:var(--accent);
    user-select:none;
  }
  .slide-body{
    background:#f2f6fa;padding:var(--panel-pad);
    overflow:hidden;
    -webkit-overflow-scrolling:auto;
  }

  /* ======= TAPAHTUMAT ======= */
  .events .slide-header{background:var(--accent)}
  .events-list{display:grid;gap:12px;max-width:1600px;margin:0 auto}
  .event-card{
    background:#fff;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.12);
    padding:12px 14px
  }
  .event-date{
    font-weight:800;color:#fff;border-radius:8px;display:inline-block;padding:5px 10px;margin-bottom:6px
  }
  .event-title{font-weight:800;font-size:1.18rem;word-break:break-word}
  .event-description{margin-top:6px;color:#333;font-size:1.02rem}

  @media (min-width: 1025px){
    .events-list{grid-auto-rows:minmax(0,1fr)}
    .event-card{padding:14px 16px}
    .event-title{font-size:1.22rem}
  }

  /* ======= SÄÄ + VAROITUKSET ======= */
  .wx-alerts .slide-header{background:var(--accent)}
  .wx-grid{
    height:100%;
    max-width:1600px; margin:0 auto;
    display:grid; gap:16px;
    grid-template-rows:auto auto 1fr;
    grid-template-columns:1fr;
    grid-template-areas:
      "wx"
      "fc"
      "warn";
  }
  .panel{background:#fff;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.12);overflow:hidden}
  .panel-h{height:48px;display:flex;align-items:center;gap:10px;font-weight:800;color:#fff;padding:0 12px;background:var(--accent)}
  .panel-b{background:#f2f6fa;padding:12px}

  .p-wx   {grid-area: wx}
  .p-fc   {grid-area: fc}
  .p-warn {grid-area: warn}

  .weather-card{display:grid;grid-template-columns:1fr auto;grid-template-rows:auto auto;gap:10px}
  .w-city{font-size:1.2rem;font-weight:900}
  .w-temp{font-size:2.2rem;font-weight:900}
  .w-row{grid-column:1/-1;display:flex;gap:10px;flex-wrap:wrap}
  .w-badge{background:#eef3f8;border-radius:8px;padding:6px 10px}
  .w-icon{font-size:1.6rem;margin-left:6px}
  .muted{opacity:.7}

  .forecast{display:grid;gap:10px;grid-template-columns:repeat(6,1fr)}
  .fc-item{background:#fff;border-radius:10px;padding:10px;box-shadow:0 1px 6px rgba(0,0,0,.12);text-align:center}
  .fc-time{font-weight:800;margin-bottom:4px}
  .fc-temp{font-size:1.05rem;font-weight:900}
  .fc-sub{font-size:.92rem;color:#333;margin-top:2px}

  .warn-list{display:grid;gap:10px}
  .warn-item{background:#fff;border-radius:10px;padding:10px 12px;box-shadow:0 2px 8px rgba(0,0,0,.12);display:grid;grid-template-columns:28px 1fr;gap:10px}
  .warn-icon{width:28px;height:28px;border-radius:50%;display:grid;place-items:center;color:#fff;font-weight:900}
  .warn-content{display:grid;gap:4px}
  .w-title{font-weight:800}
  .w-when{font-size:.95rem;opacity:.8}
  .w-desc{font-size:.98rem}
  .lvl-yellow .warn-icon{background:#f2c744;color:#1d1d1f}
  .lvl-orange .warn-icon{background:#ff9800}
  .lvl-red    .warn-icon{background:#e53935}

  /* ======= TILANNEHUONE ======= */
  .tilanne .slide-header{background:var(--accent)}
  .th-wrap{max-width:1600px; margin:0 auto; display:grid; gap:16px}
  .th-list{display:grid;gap:10px}
  .th-item{
    background:#fff;border-radius:10px;padding:12px 14px;box-shadow:0 2px 8px rgba(0,0,0,.12);
    transition: opacity .2s ease;
    font-size:1rem; /* peruskoko: pieni */
  }
  .th-item.sev-medium{font-size:1.06rem}
  .th-item.sev-large{font-size:1.12rem}
  .th-item.ended{opacity:.55}

  .th-top{display:flex;flex-wrap:wrap;gap:8px;align-items:baseline}
  .th-city{font-weight:900}
  .th-time{font-size:.95rem;opacity:.8}

  .th-title{font-weight:800;margin-top:4px;display:flex;align-items:center;gap:8px}
  .th-ico{font-size:1.25em;line-height:1}
  .th-sev{margin-left:2px;font-weight:800;opacity:.9}

  .th-desc{margin-top:8px;color:#333}
  .th-desc div{margin:.5px 0}

  /* ======= ASSET DIAT ======= */
  .slide.asset .slide-header{ background: var(--accent); }
  .slide.asset .slide-body{
    display: grid; place-items: center; overflow: hidden; background: #000;
  }
  .asset-wrap{ width:100%; height:100%; display:grid; place-items:center; background:#000; }
  .asset-wrap img{ max-width:100%; max-height:100%; height:auto; object-fit:contain; background:#000; }
  .asset-wrap iframe{ width:100%; height:100%; border:0; background:#fff; }

  /* ======= MOBIILI ======= */
  @media (max-width: 1024px){
    #clock{display:none}
    .slide-body{
      overflow:auto; -webkit-overflow-scrolling:touch; overscroll-behavior: contain;
      max-height: calc(100vh - var(--header-h) - 2*var(--gap));
    }
    .forecast{grid-template-columns:repeat(3,1fr)}
    .wx-grid{height:auto; max-width:none}
    .slide.asset .slide-body{ overflow:auto; -webkit-overflow-scrolling:touch; }
  }
</style>
</head>
<body>

<div id="clock"></div>

<div class="slides" id="slides">
  <!-- 1) TAPAHTUMAT -->
  <section class="slide events active" id="slide-events" aria-label="Miehistön Tapahtumat">
    <div class="slide-header">Miehistön Tapahtumat</div>
    <div class="slide-body">
      <div id="miehisto-events" class="events-list">
        <div class="event-card"><div class="event-title">Ladataan tapahtumia…</div></div>
      </div>
    </div>
  </section>

  <!-- 2) SÄÄ + VAROITUKSET -->
  <section class="slide wx-alerts" id="slide-wx" aria-label="Sää ja varoitukset">
    <div class="slide-header">Sää ja varoitukset</div>
    <div class="slide-body">
      <div class="wx-grid">
        <div class="panel p-wx">
          <div class="panel-h">Nykyinen sää</div>
          <div class="panel-b">
            <div id="wx-card" class="weather-card">
              <div class="w-city">Klaukkalan Metsäkylä</div>
              <div class="w-temp muted">…</div>
              <div class="w-row"><span class="w-badge">Ladataan FMI-säätietoja…</span></div>
            </div>
          </div>
        </div>
        <div class="panel p-fc">
          <div class="panel-h">Seuraavat tunnit</div>
          <div class="panel-b">
            <div id="wx-forecast" class="forecast"></div>
          </div>
        </div>
        <div class="panel p-warn">
          <div class="panel-h">Varoitukset (FMI)</div>
          <div class="panel-b">
            <div id="warn-list" class="warn-list">
              <div class="warn-item"><div class="warn-content">Ladataan varoituksia…</div></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- 3) TILANNEHUONE -->
  <section class="slide tilanne" id="slide-tilanne" aria-label="Tilannehuone">
    <div class="slide-header">Tilannehuone</div>
    <div class="slide-body">
      <div class="th-wrap">
        <div id="th-list" class="th-list">
          <div class="th-item"><div class="th-title">Ladataan hälytyksiä…</div></div>
        </div>
      </div>
    </div>
  </section>
</div>

<!-- ical.js tapahtumille -->
<script src="https://cdn.jsdelivr.net/npm/ical.js@1.4.0/build/ical.min.js"></script>
<script>
/* =============== YLEISET =============== */
const PROXY  = 'https://vpk.mijuze1.workers.dev/?url=';
const SLIDES = ['slide-events','slide-wx','slide-tilanne'];
let slideIndex = 0;
const IS_MOBILE = window.matchMedia('(max-width: 1024px)').matches;

function tickClock(){
  const now = new Date();
  const el = document.getElementById('clock');
  if (el) {
    el.textContent =
      now.toLocaleDateString('fi-FI',{weekday:'long', day:'numeric', month:'long'})+' '+
      now.toLocaleTimeString('fi-FI',{hour:'2-digit', minute:'2-digit'});
  }
}
setInterval(tickClock, 1000); tickClock();

function showSlide(i){
  SLIDES.forEach((id,idx)=>{
    const el = document.getElementById(id);
    if (!el) return;
    if (idx===i){ el.classList.add('active'); } else { el.classList.remove('active'); }
  });
}
let autoTimer = setInterval(()=>{
  slideIndex = (slideIndex + 1) % SLIDES.length;
  showSlide(slideIndex);
}, parseInt(getComputedStyle(document.documentElement).getPropertyValue('--slide-time-ms')) );

/* Swipe */
(function enableSwipe(){
  const container = document.getElementById('slides');
  if (!container) return;
  let sx=0, sy=0, moved=false, scrolling=false;
  const H=50, V=30;
  container.addEventListener('touchstart',e=>{
    if(e.touches?.length!==1) return;
    sx=e.touches[0].clientX; sy=e.touches[0].clientY; moved=false; scrolling=false;
  },{passive:true});
  container.addEventListener('touchmove',e=>{
    if(e.touches?.length!==1) return;
    const dx=e.touches[0].clientX-sx, dy=e.touches[0].clientY-sy;
    if(Math.abs(dy)>V){ scrolling=true; return; }
    if(Math.abs(dx)>5) moved=true;
  },{passive:true});
  container.addEventListener('touchend',e=>{
    if(scrolling||!moved) return;
    const dx=(e.changedTouches?.[0]?.clientX||sx)-sx;
    if(Math.abs(dx)>H){
      clearInterval(autoTimer);
      slideIndex = dx<0 ? (slideIndex+1)%SLIDES.length : (slideIndex-1+SLIDES.length)%SLIDES.length;
      showSlide(slideIndex);
      autoTimer = setInterval(()=>{ slideIndex=(slideIndex+1)%SLIDES.length; showSlide(slideIndex); },
        parseInt(getComputedStyle(document.documentElement).getPropertyValue('--slide-time-ms')) );
    }
  },{passive:true});
})();

/* Helpers */
async function fetchWithTimeout(url, ms=12000, opts={}){
  const ctrl = new AbortController(); const id = setTimeout(()=>ctrl.abort(), ms);
  try { const r = await fetch(url, {signal: ctrl.signal, cache:'no-store', ...opts}); clearTimeout(id); return r; }
  catch(e){ clearTimeout(id); throw e; }
}
function stripLinks(html) {
  if (!html) return '';
  const div = document.createElement('div'); div.innerHTML = html;
  div.querySelectorAll('a').forEach(a => a.remove());
  return (div.textContent || div.innerText || '').replace(/https?:\/\/\S+/g, '').trim();
}

/* =============== TAPAHTUMAT (Nimenhuuto ICS) =============== */
const ICS_URL = () => PROXY + encodeURIComponent('https://metsakylanvpk.nimenhuuto.com/calendar/ical') + '&_=' + Date.now();

function cleanTitle(title) {
  if (!title) return '';
  const m = title.match(/(?:–|:)\s*(.+)$/);
  if (m && m[1]) return m[1].trim();
  return title.replace(/^Metsäkylän VPK\s*[-–:]?\s*/i, '').trim();
}
function getDateColor(summary) {
  const t = (summary || '').toLowerCase();
  if (t.includes('auto')) return '#fc832f';
  if (t.includes('471') || t.includes('473') || t.includes('477')) return '#fc832f';
  if (t.includes('kalustoesittely') || t.includes('kalusto')) return '#7ab638';
  if (t.includes('päätös')) return '#fcd854';
  if (t.includes('kokous')) return '#fcd854';
  if (t.includes('esittely') || t.includes('alkusammutus') || t.includes('tapahtuma')) return '#7ab638';
  if (t.includes('jokkis') || t.includes('ralli') || t.includes('drift')) return '#7ab638';
  if (t.includes('juhla')) return '#7ab638';
  if (t.includes('retki')) return '#fcd854';        /* <-- lisäys toiveen mukaan */
  return '#2178a1';
}
function formatEventDate(sDate, eDate, allDay=false) {
  const s = new Date(sDate), e = new Date(eDate);
  const same = s.toDateString() === e.toDateString();
  if (allDay) {
    return same ? s.toLocaleDateString('fi-FI')
                : `${s.toLocaleDateString('fi-FI')} – ${e.toLocaleDateString('fi-FI')}`;
  } else if (same) {
    return `${s.toLocaleDateString('fi-FI')} klo ${s.toLocaleTimeString('fi-FI',{hour:'2-digit',minute:'2-digit'})} – ${e.toLocaleTimeString('fi-FI',{hour:'2-digit',minute:'2-digit'})}`;
  } else {
    return `${s.toLocaleDateString('fi-FI')} klo ${s.toLocaleTimeString('fi-FI',{hour:'2-digit',minute:'2-digit'})} – ${e.toLocaleDateString('fi-FI')} klo ${e.toLocaleTimeString('fi-FI',{hour:'2-digit',minute:'2-digit'})}`;
  }
}
async function loadICS(url) {
  try {
    const res = await fetchWithTimeout(url, 12000);
    if (!res.ok) return { items: [], error: `ICS: ${res.status}` };
    const text = await res.text();
    const jcal = ICAL.parse(text);
    const comp = new ICAL.Component(jcal);
    const vevents = comp.getAllSubcomponents('vevent').map(ve => new ICAL.Event(ve));
    const now = new Date();
    const LIMIT = IS_MOBILE ? 12 : 5;

    const items = vevents
      .filter(ev => ev.endDate && ev.endDate.toJSDate() > now)
      .map(ev => ({
        summary: ev.summary || '',
        description: ev.description || '',
        startDate: ev.startDate.toJSDate(),
        endDate: ev.endDate.toJSDate(),
        allDay: ev.startDate.isDate && ev.endDate.isDate
      }))
      .sort((a,b)=>a.startDate-b.startDate)
      .slice(0, LIMIT);
    return { items };
  } catch (e) {
    return { items: [], error: e.name === 'AbortError' ? 'Aikakatkaisu' : 'Verkkovirhe' };
  }
}
function renderEvents(containerId, payload) {
  const c = document.getElementById(containerId);
  c.innerHTML = '';
  const { items, error } = payload;
  if (error) { c.innerHTML = `<div class="event-card"><div class="event-title">Tietojen haku epäonnistui</div><div class="event-description">${error}</div></div>`; return; }
  if (!items || !items.length){ c.innerHTML = `<div class="event-card"><div class="event-title">Ei tulevia tapahtumia</div></div>`; return; }
  items.forEach(it=>{
    const card = document.createElement('div'); card.className='event-card';
    const date = document.createElement('div'); date.className='event-date'; date.style.background=getDateColor(it.summary);
    date.textContent = formatEventDate(it.startDate, it.endDate, it.allDay);
    const title=document.createElement('div'); title.className='event-title'; title.textContent = cleanTitle(it.summary);
    card.appendChild(date); card.appendChild(title);
    if (it.description){ const d=document.createElement('div'); d.className='event-description'; d.textContent=stripLinks(it.description); card.appendChild(d); }
    c.appendChild(card);
  });
}

/* =============== SÄÄ (FMI) =============== */
const KL = { name:'Klaukkalan Metsäkylä', lat:60.372, lon:24.740 };

function wxEmoji(symbol){
  const s = Number(symbol);
  if ([1].includes(s)) return '☀️';
  if ([2,21,22].includes(s)) return '🌤️';
  if ([3,31,32,33].includes(s)) return '⛅';
  if ([4].includes(s)) return '☁️';
  if ([5,6,7,8,9,10].includes(s)) return '🌧️';
  if ([11,12,13,14].includes(s)) return '❄️';
  if ([15,16,17,18,19,20].includes(s)) return '⛈️';
  return '🌡️';
}
function parseFmiTVP(xmlText){
  const doc = new DOMParser().parseFromString(xmlText, 'text/xml');
  const series = Array.from(doc.getElementsByTagNameNS('*','MeasurementTimeseries'));
  const outMap = new Map();
  series.forEach(ts=>{
    const id = (ts.getAttribute('gml:id')||'').toLowerCase();
    const key =
      id.includes('temperature')      ? 'T'  :
      id.includes('windspeedms')      ? 'WS' :
      id.includes('precipitation1h')  ? 'RR' :
      id.includes('weathersymbol3')   ? 'SYM': null;
    if (!key) return;
    Array.from(ts.getElementsByTagNameNS('*','MeasurementTVP')).forEach(tvp=>{
      const time = tvp.getElementsByTagNameNS('*','time')[0]?.textContent;
      const val  = tvp.getElementsByTagNameNS('*','value')[0]?.textContent;
      if (!time || val==null) return;
      const iso = new Date(time).toISOString();
      if (!outMap.has(iso)) outMap.set(iso, { time:new Date(time) });
      const rec = outMap.get(iso);
      rec[key] = Number(val);
    });
  });
  return Array.from(outMap.values()).sort((a,b)=>a.time-b.time);
}
async function loadFmiWeather(){
  const card = document.getElementById('wx-card');
  const forecastBox = document.getElementById('wx-forecast');
  card.innerHTML = `
    <div class="w-city">${KL.name}</div>
    <div class="w-temp muted">…</div>
    <div class="w-row"><span class="w-badge">Ladataan FMI-säätietoja…</span></div>`;

  try{
    const base = 'https://opendata.fmi.fi/wfs';
    const now  = new Date();
    const end  = new Date(now.getTime() + 9*60*60*1000);
    const params = new URLSearchParams({
      service:'WFS', version:'2.0.0', request:'GetFeature',
      storedquery_id:'fmi::forecast::harmonie::surface::point::timevaluepair',
      latlon:`${KL.lat},${KL.lon}`,
      parameters:'temperature,windSpeedMS,WeatherSymbol3,precipitation1h',
      starttime: now.toISOString(),
      endtime:   end.toISOString(),
      timestep:  '60'
    });
    const url = PROXY + encodeURIComponent(`${base}?${params.toString()}`) + '&_=' + Date.now();
    const r = await fetchWithTimeout(url, 15000);
    if (!r.ok) throw new Error('FMI ' + r.status);
    const xml = await r.text();
    const rows = parseFmiTVP(xml);
    if (!rows.length) throw new Error('FMI: tyhjä vastaus');

    const nowMs = Date.now();
    let current = rows.reduce((best,rec)=>{
      const d = Math.abs(rec.time - nowMs);
      return (best==null || d < best.d) ? { rec, d } : best;
    }, null)?.rec || rows[0];

    const temp = isFinite(current.T)? Math.round(current.T) : '–';
    const wind = isFinite(current.WS)? Math.round(current.WS) : '–';
    const rain = isFinite(current.RR)? current.RR.toFixed(1) : '–';
    const sym  = current.SYM!=null ? wxEmoji(current.SYM) : '🌡️';

    card.innerHTML = `
      <div class="w-city">${KL.name}</div>
      <div class="w-temp">${temp}°C <span class="w-icon">${sym}</span></div>
      <div class="w-row">
        <span class="w-badge">Tuuli ${wind} m/s</span>
        <span class="w-badge">Sade ${rain} mm/h</span>
        <span class="w-badge">Klo ${current.time.toLocaleTimeString('fi-FI',{hour:'2-digit',minute:'2-digit'})}</span>
      </div>`;

    const upcoming = rows.filter(r => r.time > current.time).slice(0,6);
    forecastBox.innerHTML = upcoming.map(r=>`
      <div class="fc-item">
        <div class="fc-time">${r.time.toLocaleTimeString('fi-FI',{hour:'2-digit',minute:'2-digit'})}</div>
        <div class="fc-temp">${isFinite(r.T)? Math.round(r.T)+'°C':'–'}</div>
        <div class="fc-sub">${wxEmoji(r.SYM||0)} ${isFinite(r.RR)? r.RR.toFixed(1):'–'} mm/h • ${isFinite(r.WS)? Math.round(r.WS):'–'} m/s</div>
      </div>
    `).join('');
  }catch(e){
    card.innerHTML = `
      <div class="w-city">${KL.name}</div>
      <div class="w-temp">–</div>
      <div class="w-row"><span class="w-badge">FMI-säätietoja ei voitu hakea</span></div>`;
    document.getElementById('wx-forecast').innerHTML = '';
  }
}

/* =============== VAROITUKSET (FMI RSS) =============== */
const FMI_RSS_FI = 'https://alerts.fmi.fi/cap/feed/rss_fi-FI.rss';
function sevClassFromText(txt){
  const t=(txt||'').toLowerCase();
  if (t.includes('punainen')||t.includes('red')) return 'lvl-red';
  if (t.includes('oranssi')||t.includes('orange')) return 'lvl-orange';
  if (t.includes('keltainen')||t.includes('yellow')) return 'lvl-yellow';
  return '';
}
function warnItemHtml(w){
  return `<div class="warn-item ${w.level}">
    <div class="warn-icon">${w.level==='lvl-red'?'!':(w.level==='lvl-orange'?'!':'i')}</div>
    <div class="warn-content">
      <div class="w-title">${w.title}</div>
      ${w.when ? `<div class="w-when">${w.when}</div>`:''}
      ${w.desc ? `<div class="w-desc">${w.desc}</div>`:''}
    </div>
  </div>`;
}
async function loadWarnings(){
  const list = document.getElementById('warn-list');
  list.innerHTML = '<div class="warn-item"><div class="warn-content">Ladataan varoituksia…</div></div>';
  try{
    const url = PROXY + encodeURIComponent(FMI_RSS_FI) + '&_=' + Date.now();
    const r = await fetchWithTimeout(url, 12000); if(!r.ok) throw new Error('FMI '+r.status);
    const xml = await r.text();
    const doc = new DOMParser().parseFromString(xml, 'text/xml');
    const items = Array.from(doc.querySelectorAll('item')).map(it=>{
      const title = it.querySelector('title')?.textContent?.trim() || 'Varoitus';
      const desc  = it.querySelector('description')?.textContent?.trim() || '';
      const pub   = it.querySelector('pubDate')?.textContent?.trim() || '';
      let when=''; try{ when = pub ? new Date(pub).toLocaleString('fi-FI') : '' }catch(_){}
      const level = sevClassFromText(title + ' ' + desc);
      return {title, desc, when, level};
    });

    const kuAll = items.filter(x => /Nurmij|Keski-?Uusimaa|Hyvink|Järvenpää|Tuusula|Kerava|Mäntsälä|Pornainen|Klaukkala|Vantaa/i.test(x.title + ' ' + x.desc));
    const limitKU = IS_MOBILE ? 10 : 5;
    const limitFI = IS_MOBILE ? 10 : 5;

    const ku = kuAll.slice(0,limitKU);
    const fi = items.slice(0,limitFI);

    if (!ku.length && !fi.length){
      list.innerHTML = '<div class="warn-item"><div class="warn-content">Ei voimassa olevia varoituksia</div></div>';
      return;
    }
    let html = '';
    if (ku.length){
      html += `<div class="warn-item" style="background:#eef3f8"><div class="warn-content"><div class="w-title">Keski-Uusimaa</div></div></div>`;
      html += ku.map(warnItemHtml).join('');
    }
    if (fi.length){
      html += `<div class="warn-item" style="background:#eef3f8"><div class="warn-content"><div class="w-title">Koko Suomi</div></div></div>`;
      html += fi.map(warnItemHtml).join('');
    }
    list.innerHTML = html;
  }catch{
    list.innerHTML = '<div class="warn-item"><div class="warn-content">Varoituksia ei voitu hakea</div></div>';
  }
}

/* =============== TILANNEHUONE (24h + infotxt + ikonit + ohi-logiikka) =============== */
const TH_URL = () => PROXY + encodeURIComponent('https://www.tilannehuone.fi/halytys.php') + '&_=' + Date.now();

/* Fallback-tekstiksi */
function cleanHtmlToText(html){
  const tmp = document.createElement('div');
  tmp.innerHTML = html.replace(/<script[\s\S]*?<\/script>/gi,'').replace(/<style[\s\S]*?<\/style>/gi,'');
  const text = tmp.textContent || tmp.innerText || '';
  return text.replace(/\u00AD/g,'').replace(/\s+/g,' ').trim();
}
function parseTilanneFromText(text){
  const results = [];
  const re = /([A-ZÅÄÖ][\wÅÄÖåäö\-\.\s/]+?)\s+(\d{2}\.\d{2}\.\d{4})\s+(\d{1,2}:\d{2}(?::\d{2})?)\s+([^\n\r]+?)(?=\s+[A-ZÅÄÖ]|$)/g;
  let m;
  while ((m = re.exec(text)) !== null) {
    const city = m[1].trim();
    const date = m[2].trim();
    const time = m[3].trim();
    const tail = m[4].trim();
    let kind = tail, level = '';
    const lv = tail.match(/:\s*(pieni|keskisuuri|suuri)\b/i);
    if (lv) { level = lv[1].toLowerCase(); kind = tail.replace(lv[0], '').trim().replace(/:$/, '').trim(); }
    const [d,mo,y] = date.split('.');
    const ts = new Date(`${y}-${mo}-${d}T${time.length===5?time+':00':time}`);
    if (!isNaN(ts.getTime())) results.push({ city, time: ts, kind, level, detail:'' });
  }
  return results;
}

/* infotxt_* keruu ja but_info_* avain */
function collectInfoBlocks(doc){
  const map = new Map();
  doc.querySelectorAll('div[id^="infotxt_"]').forEach(div=>{
    const id = (div.id||'').replace('infotxt_','');
    const txt = (div.textContent||'').replace(/\s+\n/g,'\n').replace(/\s+/g,' ').trim();
    if (id && txt) map.set(id, txt);
  });
  return map;
}
function findInfoKeyFromRow(row){
  const withClass = [row, ...row.querySelectorAll('[class]')];
  for (const el of withClass){
    for (const cls of (el.className||'').toString().split(/\s+/)){
      const m = cls.match(/^but_info_([a-f0-9]+)/i);
      if (m) return m[1];
    }
  }
  let sib = row.nextElementSibling;
  if (sib && /^infotxt_/.test(sib.id||'')) return (sib.id||'').replace('infotxt_','');
  return null;
}

/* DOM-parsi */
function parseTilanneFromDom(html){
  const doc = new DOMParser().parseFromString(html, 'text/html');
  const infoMap = collectInfoBlocks(doc);

  let rows = [];
  const sels = ['.pfade','li','tr','.list-item','.news-item','.event','.content ul li','.items > *'];
  sels.forEach(sel => rows.push(...doc.querySelectorAll(sel)));
  rows = rows.filter(el => (el.textContent||'').trim().length > 20).slice(0,1500);

  const lineRe = /([A-ZÅÄÖ][\wÅÄÖåäö\-\.\s/]+?)\s+(\d{2}\.\d{2}\.\d{4})\s+(\d{1,2}:\d{2}(?::\d{2})?)\s+(.+)/;

  const items = [];
  for (const row of rows){
    const text = (row.textContent||'').replace(/\u00AD/g,'').replace(/\s+/g,' ').trim();
    const m = text.match(lineRe);
    if (!m) continue;

    let city = m[1].trim();
    let date = m[2].trim();
    let time = m[3].trim();
    let tail = m[4].trim();

    let kind = tail, level = '';
    const lv = tail.match(/:\s*(pieni|keskisuuri|suuri)\b/i);
    if (lv) { level = lv[1].toLowerCase(); kind = tail.replace(lv[0], '').trim().replace(/:$/, '').trim(); }

    const [d,mo,y] = date.split('.');
    const ts = new Date(`${y}-${mo}-${d}T${time.length===5?time+':00':time}`);
    if (isNaN(ts.getTime())) continue;

    const key = findInfoKeyFromRow(row);
    const detail = key ? (infoMap.get(key) || '') : '';

    items.push({ city, time: ts, kind, level, detail });
  }

  if (!items.length) return parseTilanneFromText(cleanHtmlToText(html));

  // dedupe
  const seen = new Set(); const uniq = [];
  for (const it of items){
    const k = `${it.city}|${it.time.toISOString()}|${(it.kind||'').toLowerCase()}`;
    if (!seen.has(k)){ seen.add(k); uniq.push(it); }
  }
  return uniq;
}

/* Lisätiedon siistintä riveiksi + leikkaus Päivitetty: jälkeen */
function tidyDetail(raw){
  if (!raw) return '';
  let t = raw;

  // poista "Avaa tehtäväsivu" ja muut linkkitekstit
  t = t.replace(/Avaa\s+tehtäväsivu[\s\S]*$/i, '').trim();

  // Lisää rivinvaihdot tunnetuista kentistä
  t = t.replace(/\s*(Paikka:)\s*/i, '\n$1 ')
       .replace(/\s*(Tarkempi\s*paikka:)\s*/i, '\n$1 ')
       .replace(/\s*(Ajankohta:)\s*/i, '\n$1 ')
       .replace(/\s*(Päivitetty:)\s*/i, '\n$1 ');

  // Jos löytyy Päivitetty:, katkaise sitä seuraavaan rivinvaihtoon/tekstiin (jätetään Päivitetty-rivi mukaan)
  const p = t.match(/([\s\S]*?\nPäivitetty:.*?)(?:\n|$)/i);
  if (p) t = p[1];

  // pilko riveiksi ja siisti
  const lines = t.split('\n')
    .map(s=>s.replace(/\s+/g,' ').trim())
    .filter(Boolean);

  return lines;
}

/* Ikoni tehtävätyypille */
function iconForTask(kind){
  const k = (kind||'').toLowerCase();

  // liikenne
  if (/tieliikenne|liikenneonnettom|kolari|ketjukol/.test(k)) return '🚗';
  if (/tietyö|liikennehäiri|este tiellä|liukas|hirvi|poro|eläin tiellä/.test(k)) return '🚧';
  if (/ajoneuvopalo|liikennevälinepalo/.test(k)) return '🚗🔥';

  // palot
  if (/palohälytys/.test(k)) return '🚨';
  if (/rakennuspalo|asuntopalo|saneer/.test(k)) return '🏠🔥';
  if (/maastopalo|ruohikkopalo|metsäpalo/.test(k)) return '🌲🔥';
  if (/savuhavainto|savua/.test(k)) return '🌫️';

  // vuodot / vaaralliset
  if (/öljy|polttoaine|vuoto/.test(k)) return '🛢️';
  if (/vaarall.*aine|kemika|kaasu/.test(k)) return '☣️';

  // vesi
  if (/vesiliiken|vene|uppo|jäätilanne/.test(k)) return '🚤';
  if (/vesivahinko|putkirikko|tulva/.test(k)) return '💧';

  // pelastus
  if (/pelastus|henkilö.*pelastus|ihminen/.test(k)) return '🛟';
  if (/etsintä|kadonnut/.test(k)) return '🧭';
  if (/hissiin.*jäänyt|hissivika/.test(k)) return '🛗';

  // myrsky / sähkö / puu
  if (/myrsky|tuuli|puu.*tiellä|oksia/.test(k)) return '🌬️';
  if (/sähkö|sähkötapaturma|sähkövika/.test(k)) return '⚡';

  // eläin
  if (/eläin/.test(k)) return '🐾';

  // sortuma
  if (/sortuma|romaht|rakennevaurio/.test(k)) return '🧱';

  // muut
  return '🛈';
}

/* Kortin kokoluokka */
function levelToCardClass(level){
  const l=(level||'').toLowerCase();
  if (l.includes('suuri')) return 'sev-large';
  if (l.includes('keskisuuri')) return 'sev-medium';
  return ''; // pieni -> perus
}
function capitalFirst(s){ return s ? s.charAt(0).toUpperCase()+s.slice(1) : s; }

/* Päättyneen tilanteen tunnistus */
function isEnded(it){
  const now = Date.now();
  const ageMs = now - it.time.getTime();

  // Suora vihje lisätiedoista
  const d = (it.detail||'').toLowerCase();
  if (/tilanne\s+ohi|tehtäv[aä]\s+ohi|ilmoitus.*päättynyt|päättynyt|poistettu/.test(d)) return true;

  // Heuristiikka tasosta
  const lvl = (it.level||'').toLowerCase();
  const twoH = 2*60*60*1000, fourH = 4*60*60*1000, eightH = 8*60*60*1000, threeH = 3*60*60*1000;
  if (lvl.includes('suuri'))      return ageMs > eightH;
  if (lvl.includes('keskisuuri')) return ageMs > fourH;
  if (lvl.includes('pieni'))      return ageMs > twoH;
  return ageMs > threeH;
}

async function loadTilannehuone(){
  const box = document.getElementById('th-list');
  if (!box) return;
  box.innerHTML = '<div class="th-item"><div class="th-title">Ladataan hälytyksiä…</div></div>';

  try{
    const resp = await fetchWithTimeout(TH_URL(), 15000);
    const html = await resp.text();
    if (!resp.ok) throw new Error('HTTP ' + resp.status);

    let items = parseTilanneFromDom(html);

    // 24h suodatus, uusin ensin, maksimissaan 20
    const now = Date.now(), dayMs = 24*60*60*1000;
    items = items
      .filter(it => (now - it.time.getTime()) <= dayMs)
      .sort((a,b)=>b.time - a.time)
      .slice(0, 20);

    if (!items.length){
      box.innerHTML = '<div class="th-item"><div class="th-title">Ei tuoreita hälytyksiä</div></div>';
      return;
    }

    box.innerHTML = items.map(it=>{
      const ico = iconForTask(it.kind);
      const clsSize = levelToCardClass(it.level);
      const ended = isEnded(it);
      const timeText = it.time.toLocaleString('fi-FI');
      const titleTxt = capitalFirst((it.kind||'Hälytys').replace(/\s+/g,' '));
      const levelTxt = it.level ? ` <span class="th-sev">(${capitalFirst(it.level)})</span>` : '';

      const detailLines = tidyDetail(it.detail||'');
      const detailHtml = detailLines.length
        ? `<div class="th-desc">${detailLines.map(l=>`<div>${l}</div>`).join('')}</div>`
        : '';

      return `<div class="th-item ${clsSize}${ended ? ' ended' : ''}">
        <div class="th-top">
          <div class="th-city">${it.city}</div>
          <div class="th-time">${timeText}</div>
        </div>
        <div class="th-title"><span class="th-ico">${ico}</span>${titleTxt}${levelTxt}</div>
        ${detailHtml}
      </div>`;
    }).join('');

  }catch(e){
    console.error('Tilannehuone:', e);
    box.innerHTML = '<div class="th-item"><div class="th-title">Hälytyksiä ei voitu hakea</div></div>';
  }
}

/* =============== ASSET-DIAT (kuva/pdf/html) =============== */
const CUSTOM_ASSETS = [
  // Lisää tänne omat tiedostot (jos eivät ole olemassa, diaa ei lisätä)
  // { type: 'img',  title: 'Infokuva',  src: './info.jpg' },
  // { type: 'pdf',  title: 'Ohjeistus', src: './ohje.pdf#view=FitH&toolbar=0&navpanes=0' },
  // { type: 'page', title: 'Tiedotesivu', src: './tiedote.html' }
];
async function exists(url){
  try{
    const h = await fetchWithTimeout(url, 6000, { method:'HEAD' });
    if (h.ok) return true;
    const g = await fetchWithTimeout(url, 6000, { method:'GET' });
    return g.ok;
  }catch{ return false; }
}
async function filterExistingAssets(list){
  const out = [];
  for (const a of list){
    if (!a || !a.src) continue;
    try{ if (await exists(a.src)) out.push(a); }catch(_){}
  }
  return out;
}
async function addAssetSlides(){
  const assets = await filterExistingAssets(CUSTOM_ASSETS);
  if (!assets.length) return;
  const root = document.querySelector('.slides'); if (!root) return;

  assets.forEach((asset, idx) => {
    const id = `slide-asset-${idx+1}`;
    const sec = document.createElement('section');
    sec.className = 'slide asset';
    sec.id = id;
    sec.setAttribute('aria-label', asset.title || 'Dia');

    const header = document.createElement('div');
    header.className = 'slide-header';
    header.textContent = asset.title || 'Dia';

    const body = document.createElement('div');
    body.className = 'slide-body';

    const wrap = document.createElement('div');
    wrap.className = 'asset-wrap';

    const type = (asset.type || '').toLowerCase();
    if (type === 'img') {
      const img = document.createElement('img');
      img.src = asset.src; img.alt = asset.title || '';
      wrap.appendChild(img);
    } else if (type === 'pdf') {
      const iframe = document.createElement('iframe');
      iframe.src = asset.src;
      wrap.appendChild(iframe);
    } else { // 'page' tai muu
      const iframe = document.createElement('iframe');
      iframe.src = asset.src;
      wrap.appendChild(iframe);
    }

    body.appendChild(wrap);
    sec.appendChild(header);
    sec.appendChild(body);
    root.appendChild(sec);

    SLIDES.push(id);
  });
}

/* =============== INIT + PÄIVITYKSET =============== */
async function init(){
  await addAssetSlides();

  const ev = await loadICS(ICS_URL());   renderEvents('miehisto-events', ev);
  await loadFmiWeather();
  await loadWarnings();
  await loadTilannehuone();

  setInterval(async ()=>{ const e=await loadICS(ICS_URL()); renderEvents('miehisto-events', e); }, 5*60*1000);
  setInterval(loadFmiWeather,  10*60*1000);
  setInterval(loadWarnings,    10*60*1000);
  setInterval(loadTilannehuone, 5*60*1000);
}
init();
</script>
</body>
</html>
