<!DOCTYPE html>
<html lang="fi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Tapahtumat</title>
  <script src="https://cdn.jsdelivr.net/npm/ical.js@1.4.0/build/ical.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f4f9;
      margin: 0;
      padding: 0;
    }
    h1 {
      text-align: center;
      padding: 1rem;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1rem;
      padding: 1rem;
    }
    .card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      padding: 1rem;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }
    .date {
      font-weight: bold;
      font-size: 1.1rem;
      margin-bottom: 0.5rem;
      padding: 0.3rem;
      border-radius: 8px;
      color: white;
      text-align: center;
    }
    .summary {
      font-size: 1rem;
      margin-bottom: 0.5rem;
    }
    .time {
      font-size: 0.9rem;
      color: #555;
      margin-bottom: 0.5rem;
    }
    .participants {
      font-size: 0.9rem;
      color: #333;
    }
  </style>
</head>
<body>
  <h1>Tapahtumat</h1>
  <div class="grid" id="events"></div>

  <script>
    const ICAL_URLS = [
      { url: "https://metsakylanvpk.nimenhuuto.com/calendar/ical", name: "Metsäkylän VPK" },
      { url: "https://metsakylanvpknuoriso-osasto.nimenhuuto.com/calendar/ical", name: "Nuoriso-osasto" }
    ];

    const COLORS = {
      Harjoitukset: "#1e90ff",
      "Sammutus kilpailut": "#ff6347",
      "Varainhankinta": "#ffa500",
      "Kalusto": "#32cd32",
      "Koulutus": "#8a2be2",
      "Nuoriso-osasto": "#ff1493",
      "Muu": "#708090"
    };

    function getColor(summary) {
      for (let key in COLORS) {
        if (summary.toLowerCase().includes(key.toLowerCase())) {
          return COLORS[key];
        }
      }
      return "#444"; // oletusväri
    }

    async function fetchParticipants(url) {
      try {
        const response = await fetch(url);
        const data = await response.json();
        return { in: data.in || 0, out: data.out || 0 };
      } catch (e) {
        return { in: 0, out: 0 }; // fallback jos ei saada JSONia
      }
    }

    async function loadCalendar() {
      let allEvents = [];

      for (const { url, name } of ICAL_URLS) {
        const response = await fetch(url);
        const icalData = await response.text();
        const jcalData = ICAL.parse(icalData);
        const comp = new ICAL.Component(jcalData);
        const vevents = comp.getAllSubcomponents("vevent");

        vevents.forEach(vevent => {
          const event = new ICAL.Event(vevent);
          if (event.startDate.toJSDate() >= new Date()) {
            allEvents.push({
              calendar: name,
              summary: event.summary,
              start: event.startDate.toJSDate(),
              end: event.endDate ? event.endDate.toJSDate() : null
            });
          }
        });
      }

      allEvents.sort((a, b) => a.start - b.start);

      const container = document.getElementById("events");
      container.innerHTML = "";

      for (const ev of allEvents) {
        const dateColor = getColor(ev.summary);

        // jos sama päivä → näytetään kloajat
        let timeText = "";
        if (ev.end && ev.start.toDateString() === ev.end.toDateString()) {
          timeText = `${ev.start.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'})} – ${ev.end.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'})}`;
        } else if (ev.end) {
          timeText = `${ev.start.toLocaleString()} – ${ev.end.toLocaleString()}`;
        } else {
          timeText = ev.start.toLocaleString();
        }

        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <div class="date" style="background:${dateColor}">
            ${ev.start.toLocaleDateString("fi-FI", {weekday:"short", day:"numeric", month:"numeric"})}
          </div>
          <div class="summary">${ev.summary}</div>
          <div class="time">${timeText}</div>
          <div class="participants">IN: 0 | OUT: 0</div>
        `;
        container.appendChild(card);
      }
    }

    loadCalendar();
    setInterval(loadCalendar, 5 * 60 * 1000); // päivitys 5 min välein
  </script>

  <!--
  <div class="bottom-container">
    <iframe src="https://calendar.google.com/calendar/embed?src=..." style="border:0" width="800" height="600" frameborder="0" scrolling="no"></iframe>
  </div>
  -->

</body>
</html>
