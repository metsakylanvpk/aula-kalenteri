<!DOCTYPE html>
<html lang="fi">
<head>
  <meta charset="UTF-8">
  <title>Metsäkylän VPK Tapahtumat</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f7f7f7;
      margin: 0;
      padding: 20px;
    }
    h2 {
      margin-top: 0;
    }
    .event {
      background: #fff;
      padding: 12px;
      margin: 10px 0;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .date {
      font-weight: bold;
      font-size: 18px;
      margin-bottom: 6px;
    }
    .title {
      font-size: 16px;
    }
    .description {
      font-size: 14px;
      color: #444;
      margin-top: 4px;
    }
    /* Värikoodaus päivämäärälle */
    .harjoitus .date { color: green; }
    .peli .date { color: blue; }
    .kokous .date { color: orange; }
    .muu .date { color: gray; }
  </style>
</head>
<body>
  <h2>Tulevat tapahtumat</h2>
  <div id="events"></div>

  <script>
    const feeds = [
      "https://corsproxy.io/?" + encodeURIComponent("https://metsakylanvpk.nimenhuuto.com/calendar/ical"),
      "https://corsproxy.io/?" + encodeURIComponent("https://metsakylanvpknuoriso-osasto.nimenhuuto.com/calendar/ical")
    ];

    async function loadICS(url) {
      const res = await fetch(url);
      return res.text();
    }

    function parseICS(ics) {
      const events = [];
      const lines = ics.split(/\r?\n/);
      let event = null;

      lines.forEach(line => {
        if (line.startsWith("BEGIN:VEVENT")) {
          event = {};
        } else if (line.startsWith("END:VEVENT")) {
          if (event) events.push(event);
          event = null;
        } else if (event) {
          if (line.startsWith("DTSTART")) {
            event.start = parseDate(line.split(":")[1]);
          }
          if (line.startsWith("DTEND")) {
            event.end = parseDate(line.split(":")[1]);
          }
          if (line.startsWith("SUMMARY")) {
            event.title = line.split(":")[1];
          }
          if (line.startsWith("DESCRIPTION")) {
            event.description = line.split(":")[1];
          }
        }
      });
      return events;
    }

    function parseDate(str) {
      return new Date(
        str.substring(0,4),
        str.substring(4,6)-1,
        str.substring(6,8),
        str.substring(9,11)||0,
        str.substring(11,13)||0
      );
    }

    function categorize(title) {
      title = title.toLowerCase();
      if (title.includes("harkka") || title.includes("harjoitus")) return "harjoitus";
      if (title.includes("peli") || title.includes("ottelu")) return "peli";
      if (title.includes("kokous")) return "kokous";
      return "muu";
    }

    async function showEvents() {
      let allEvents = [];
      for (let feed of feeds) {
        const ics = await loadICS(feed);
        allEvents = allEvents.concat(parseICS(ics));
      }

      allEvents.sort((a,b) => a.start - b.start);

      const container = document.getElementById("events");
      container.innerHTML = "";

      allEvents.slice(0,10).forEach(ev => {
        const div = document.createElement("div");
        div.className = "event " + categorize(ev.title);

        div.innerHTML = `
          <div class="date">${ev.start.toLocaleDateString("fi-FI")} ${ev.start.toLocaleTimeString("fi-FI",{hour:"2-digit",minute:"2-digit"})} - ${ev.end.toLocaleTimeString("fi-FI",{hour:"2-digit",minute:"2-digit"})}</div>
          <div class="title">${ev.title.replace(/^Metsäkylän VPK( Nuoriso-osasto)?:\s*/,"")}</div>
          <div class="description">${ev.description ? ev.description.replace(/https?:\/\/\S+/g,"") : ""}</div>
        `;
        container.appendChild(div);
      });
    }

    showEvents();
  </script>
</body>
</html>
