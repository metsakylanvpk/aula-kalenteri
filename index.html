<!DOCTYPE html>
<html lang="fi">
<head>
  <meta charset="UTF-8">
  <title>Nimenhuuto Kalenteri</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 20px;
    }
    .calendar {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 16px;
    }
    .card {
      padding: 12px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      background: #fff;
    }
    .title {
      font-weight: bold;
      margin-bottom: 6px;
    }
    .time {
      color: #333;
      font-size: 14px;
    }
    .location {
      font-size: 13px;
      color: #555;
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <h1>Tapahtumat</h1>
  <div id="calendar" class="calendar"></div>

  <script>
    const urls = [
      "https://metsakylanvpk.nimenhuuto.com/public/calendar/ics?groupId=1",
      "https://metsakylanvpk.nimenhuuto.com/public/calendar/ics?groupId=2"
    ];

    // Tyyppien värit kuvan mukaisesti
    const typeColors = {
      "Harkka": "#c6dce2",
      "Auto": "#fddac4",
      "Kalustoesittely": "#d7e3a1",
      "Muu tapahtuma": "#f8f3c0",
      "Ei käytössä": "#c0e3e3"
    };

    async function loadCalendar() {
      let events = [];
      for (const url of urls) {
        const response = await fetch(url);
        const text = await response.text();
        events = events.concat(parseICS(text));
      }

      // järjestä aikajärjestykseen
      events.sort((a, b) => a.start - b.start);

      const container = document.getElementById("calendar");
      container.innerHTML = "";
      for (const ev of events) {
        // valitaan väri summaryn mukaan
        let bg = "#fff";
        for (const key in typeColors) {
          if (ev.summary && ev.summary.toLowerCase().includes(key.toLowerCase())) {
            bg = typeColors[key];
            break;
          }
        }

        const card = document.createElement("div");
        card.className = "card";
        card.style.background = bg;

        const title = document.createElement("div");
        title.className = "title";
        title.textContent = ev.summary || "Tapahtuma";

        const time = document.createElement("div");
        time.className = "time";
        let timeText = formatDate(ev.start);
        if (ev.end && ev.start.toDateString() === ev.end.toDateString()) {
          timeText += " – " + formatTime(ev.end);
        } else if (ev.end) {
          timeText += " – " + formatDate(ev.end);
        }
        time.textContent = timeText;

        card.appendChild(title);
        card.appendChild(time);

        if (ev.location) {
          const loc = document.createElement("div");
          loc.className = "location";
          loc.textContent = ev.location;
          card.appendChild(loc);
        }

        container.appendChild(card);
      }
    }

    function parseICS(text) {
      const lines = text.split(/\r?\n/);
      const events = [];
      let current = null;
      for (let line of lines) {
        if (line.startsWith("BEGIN:VEVENT")) {
          current = {};
        } else if (line.startsWith("END:VEVENT")) {
          if (current) events.push(current);
          current = null;
        } else if (current) {
          if (line.startsWith("SUMMARY:")) {
            current.summary = line.substring(8).trim();
          } else if (line.startsWith("DTSTART")) {
            current.start = parseICalDate(line.split(":")[1]);
          } else if (line.startsWith("DTEND")) {
            current.end = parseICalDate(line.split(":")[1]);
          } else if (line.startsWith("LOCATION:")) {
            current.location = line.substring(9).trim();
          }
        }
      }
      return events;
    }

    function parseICalDate(value) {
      if (!value) return null;
      const year = parseInt(value.slice(0,4));
      const month = parseInt(value.slice(4,6)) - 1;
      const day = parseInt(value.slice(6,8));
      const hour = value.length >= 11 ? parseInt(value.slice(9,11)) : 0;
      const minute = value.length >= 13 ? parseInt(value.slice(11,13)) : 0;
      return new Date(year, month, day, hour, minute);
    }

    function formatDate(date) {
      if (!date) return "";
      return date.getDate() + "." + (date.getMonth()+1) + ". klo " + formatTime(date);
    }

    function formatTime(date) {
      if (!date) return "";
      return date.getHours().toString().padStart(2,"0") + ":" +
             date.getMinutes().toString().padStart(2,"0");
    }

    loadCalendar();
    setInterval(loadCalendar, 5 * 60 * 1000); // päivitys 5 min välein
  </script>
</body>
</html>
