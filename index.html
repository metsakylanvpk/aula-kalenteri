<!DOCTYPE html>
<html lang="fi">
<head>
<meta charset="UTF-8" />
<title>Aulan n√§ytt√∂ ‚Äì Tapahtumat ‚Ä¢ S√§√§ ‚Ä¢ Varoitukset ‚Ä¢ Liikenne</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<style>
  :root{
    --gap: 16px;
    --panel-pad: 16px;
    --header-h: 64px;
    --accent: #007b83;
    --slide-time-ms: 20000; /* 20 s per n√§kym√§ */
  }
  html,body{margin:0;height:100vh;width:100vw;background:#e9eef3;color:#111;font-family:"Segoe UI",Tahoma,Verdana,sans-serif;overflow:hidden}
  #clock{position:fixed;top:10px;right:16px;font-size:1.25rem;font-weight:700;background:rgba(0,0,0,.6);color:#fff;padding:6px 10px;border-radius:8px;z-index:10}

  /* SLIDE-CONTTAINER (yksi n√§kyviss√§ kerrallaan) */
  .slides{height:100%;width:100%;position:relative}
  .slide{
    position:absolute;inset:0;background:#fff;border-radius:16px;box-shadow:0 6px 20px rgba(0,0,0,.15);
    display:grid;grid-template-rows:var(--header-h) 1fr;overflow:hidden;opacity:0;pointer-events:none;transform:scale(.98);
    transition:opacity .4s ease, transform .4s ease;
    margin: var(--gap);
  }
  .slide.active{opacity:1;pointer-events:auto;transform:scale(1)}
  .slide-header{display:flex;align-items:center;justify-content:center;font-weight:800;font-size:1.5rem;color:#fff;background:var(--accent)}
  .slide-body{background:#f2f6fa;padding:var(--panel-pad);overflow:auto;-webkit-overflow-scrolling:touch}

  /* ======= TAPAHTUMAT (pidet√§√§n kuten toimivassa versiossa) ======= */
  .events .slide-header{background:#007b83}
  .events-list{display:grid;gap:12px}
  .event-card{background:#fff;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.12);padding:12px 14px}
  .event-card:hover{box-shadow:0 4px 12px rgba(0,0,0,.2)}
  .event-date{font-weight:800;color:#fff;border-radius:8px;display:inline-block;padding:5px 10px;margin-bottom:8px}
  .event-title{font-weight:800;font-size:1.2rem;word-break:break-word}
  .event-description{margin-top:6px;color:#333}

  /* ======= S√Ñ√Ñ ======= */
  .weather .slide-header{background:#3b82f6}
  .weather-card{
    max-width:900px;margin:0 auto;background:#fff;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.12);
    padding:18px 20px;display:grid;grid-template-columns:1fr auto;grid-template-rows:auto auto;gap:12px
  }
  .w-city{font-size:1.3rem;font-weight:900}
  .w-temp{font-size:2.6rem;font-weight:900}
  .w-row{grid-column:1/-1;display:flex;gap:12px;flex-wrap:wrap}
  .w-badge{background:#eef3f8;border-radius:8px;padding:6px 10px}
  .w-icon{font-size:2rem;margin-left:8px}
  .muted{opacity:.7}

  /* ======= VAROITUKSET (FMI CAP) ======= */
  .warn .slide-header{background:#2b3648}
  .warn-list{display:grid;gap:10px;max-width:1200px;margin:0 auto}
  .warn-item{background:#fff;border-radius:10px;padding:10px 12px;box-shadow:0 2px 8px rgba(0,0,0,.12);display:grid;grid-template-columns:28px 1fr;gap:10px}
  .warn-icon{width:28px;height:28px;border-radius:50%;display:grid;place-items:center;color:#fff;font-weight:900}
  .warn-content{display:grid;gap:4px}
  .w-title{font-weight:800}
  .w-when{font-size:.95rem;opacity:.8}
  .w-desc{font-size:.98rem}
  .lvl-yellow .warn-icon{background:#f2c744;color:#1d1d1f}
  .lvl-orange .warn-icon{background:#ff9800}
  .lvl-red    .warn-icon{background:#e53935}

  /* ======= LIIKENNE ======= */
  .traffic .slide-header{background:#8b5cf6}
  .traffic-list{display:grid;gap:10px;max-width:1200px;margin:0 auto}
  .traffic-item{background:#fff;border-radius:10px;padding:10px 12px;box-shadow:0 2px 8px rgba(0,0,0,.12)}
  .t-title{font-weight:800;margin-bottom:4px}
  .t-meta{font-size:.95rem;color:#444}
  .t-desc{margin-top:6px;color:#333}

  @media (max-width: 1100px){
    .event-title{font-size:1.1rem}
    .w-temp{font-size:2.2rem}
  }
</style>
</head>
<body>

<div id="clock"></div>

<div class="slides">
  <!-- 1) TAPAHTUMAT -->
  <section class="slide events active" id="slide-events" aria-label="Miehist√∂n Tapahtumat">
    <div class="slide-header">Miehist√∂n Tapahtumat</div>
    <div class="slide-body">
      <div id="miehisto-events" class="events-list">
        <div class="event-card"><div class="event-title">Ladataan tapahtumia‚Ä¶</div></div>
      </div>
    </div>
  </section>

  <!-- 2) S√Ñ√Ñ (Klaukkalan Mets√§kyl√§) -->
  <section class="slide weather" id="slide-weather" aria-label="S√§√§ ‚Äì Klaukkalan Mets√§kyl√§">
    <div class="slide-header">S√§√§ ‚Äì Klaukkalan Mets√§kyl√§</div>
    <div class="slide-body">
      <div id="wx-card" class="weather-card">
        <div class="w-city">Klaukkalan Mets√§kyl√§</div>
        <div class="w-temp muted">‚Ä¶</div>
        <div class="w-row"><span class="w-badge">Ladataan‚Ä¶</span></div>
      </div>
    </div>
  </section>

  <!-- 3) VAROITUKSET (FMI CAP) -->
  <section class="slide warn" id="slide-warn" aria-label="Viranomaisten varoitukset">
    <div class="slide-header">Viranomaisten varoitukset ‚Äì FMI</div>
    <div class="slide-body">
      <div id="warn-list" class="warn-list">
        <div class="warn-item"><div class="warn-content">Ladataan varoituksia‚Ä¶</div></div>
      </div>
    </div>
  </section>

  <!-- 4) LIIKENNETIEDOTTEET -->
  <section class="slide traffic" id="slide-traffic" aria-label="Liikennetiedotteet">
    <div class="slide-header">Liikennetiedotteet ‚Äì Digitraffic</div>
    <div class="slide-body">
      <div id="traffic-list" class="traffic-list">
        <div class="traffic-item"><div class="t-title">Ladataan liikennetietoja‚Ä¶</div></div>
      </div>
    </div>
  </section>
</div>

<!-- ical.js tapahtumille -->
<script src="https://cdn.jsdelivr.net/npm/ical.js@1.4.0/build/ical.min.js"></script>
<script>
/* ===================== YLEISET ===================== */
const PROXY  = 'https://vpk.mijuze1.workers.dev/?url=';   // vaihda jos eri
const SLIDES = ['slide-events','slide-weather','slide-warn','slide-traffic'];
let   slideIndex = 0;

/* Kello */
function tickClock(){
  const now = new Date();
  document.getElementById('clock').textContent =
    now.toLocaleDateString('fi-FI',{weekday:'long', day:'numeric', month:'long'})+' '+
    now.toLocaleTimeString('fi-FI',{hour:'2-digit', minute:'2-digit'});
}
setInterval(tickClock, 1000); tickClock();

/* Vaihda n√§kyv√§√§ slidi√§ */
function showSlide(i){
  SLIDES.forEach((id,idx)=>{
    const el = document.getElementById(id);
    if (idx===i){ el.classList.add('active'); } else { el.classList.remove('active'); }
  });
}
setInterval(()=>{
  slideIndex = (slideIndex + 1) % SLIDES.length;
  showSlide(slideIndex);
}, parseInt(getComputedStyle(document.documentElement).getPropertyValue('--slide-time-ms')) );

/* Timeout-apu */
async function fetchWithTimeout(url, ms=9000){
  const ctrl = new AbortController(); const id = setTimeout(()=>ctrl.abort(), ms);
  try { const r = await fetch(url, {signal: ctrl.signal, cache:'no-store'}); clearTimeout(id); return r; }
  catch(e){ clearTimeout(id); throw e; }
}

/* ===================== 1) TAPAHTUMAT (Nimenhuuto ICS) ===================== */
const ICS_URL = () => PROXY + encodeURIComponent('https://metsakylanvpk.nimenhuuto.com/calendar/ical') + '&_=' + Date.now();

function cleanTitle(title) {
  if (!title) return '';
  const m = title.match(/(?:‚Äì|:)\s*(.+)$/);
  if (m && m[1]) return m[1].trim();
  return title.replace(/^Mets√§kyl√§n VPK\s*[-‚Äì:]?\s*/i, '').trim();
}
function getDateColor(summary) {
  const t = (summary || '').toLowerCase();
  if (t.includes('auto')) return '#fc832f';
  if (t.includes('471') || t.includes('473') || t.includes('477')) return '#fc832f';
  if (t.includes('kalustoesittely') || t.includes('kalusto')) return '#7ab638';
  if (t.includes('p√§√§t√∂s')) return '#fcd854';
  if (t.includes('kokous')) return '#fcd854';
  if (t.includes('esittely') || t.includes('alkusammutus') || t.includes('tapahtuma')) return '#7ab638';
  if (t.includes('jokkis') || t.includes('ralli') || t.includes('drift')) return '#7ab638';
  if (t.includes('juhla')) return '#7ab638';
  return '#2178a1';
}
function stripLinks(html) {
  if (!html) return '';
  const div = document.createElement('div'); div.innerHTML = html;
  div.querySelectorAll('a').forEach(a => a.remove());
  return (div.textContent || div.innerText || '').replace(/https?:\/\/\S+/g, '').trim();
}
function formatEventDate(sDate, eDate, allDay=false) {
  const s = new Date(sDate), e = new Date(eDate);
  const same = s.toDateString() === e.toDateString();
  if (allDay) {
    return same ? s.toLocaleDateString('fi-FI')
                : `${s.toLocaleDateString('fi-FI')} ‚Äì ${e.toLocaleDateString('fi-FI')}`;
  } else if (same) {
    return `${s.toLocaleDateString('fi-FI')} klo ${s.toLocaleTimeString('fi-FI',{hour:'2-digit',minute:'2-digit'})} ‚Äì ${e.toLocaleTimeString('fi-FI',{hour:'2-digit',minute:'2-digit'})}`;
  } else {
    return `${s.toLocaleDateString('fi-FI')} klo ${s.toLocaleTimeString('fi-FI',{hour:'2-digit',minute:'2-digit'})} ‚Äì ${e.toLocaleDateString('fi-FI')} klo ${e.toLocaleTimeString('fi-FI',{hour:'2-digit',minute:'2-digit'})}`;
  }
}
async function loadICS(url) {
  try {
    const res = await fetchWithTimeout(url, 12000);
    if (!res.ok) return { items: [], error: `ICS: ${res.status}` };
    const text = await res.text();
    const jcal = ICAL.parse(text);
    const comp = new ICAL.Component(jcal);
    const vevents = comp.getAllSubcomponents('vevent').map(ve => new ICAL.Event(ve));
    const now = new Date();
    const items = vevents
      .filter(ev => ev.endDate && ev.endDate.toJSDate() > now)
      .map(ev => ({
        summary: ev.summary || '',
        description: ev.description || '',
        startDate: ev.startDate.toJSDate(),
        endDate: ev.endDate.toJSDate(),
        allDay: ev.startDate.isDate && ev.endDate.isDate
      }))
      .sort((a,b)=>a.startDate-b.startDate);
    return { items };
  } catch (e) {
    return { items: [], error: e.name === 'AbortError' ? 'Aikakatkaisu' : 'Verkkovirhe' };
  }
}
function renderEvents(containerId, payload) {
  const c = document.getElementById(containerId);
  c.innerHTML = '';
  const { items, error } = payload;
  if (error) { c.innerHTML = `<div class="event-card"><div class="event-title">Tietojen haku ep√§onnistui</div><div class="event-description">${error}</div></div>`; return; }
  if (!items || !items.length){ c.innerHTML = `<div class="event-card"><div class="event-title">Ei tulevia tapahtumia</div></div>`; return; }
  items.forEach(it=>{
    const card = document.createElement('div'); card.className='event-card';
    const date = document.createElement('div'); date.className='event-date'; date.style.background=getDateColor(it.summary);
    date.textContent = formatEventDate(it.startDate, it.endDate, it.allDay);
    const title=document.createElement('div'); title.className='event-title'; title.textContent = cleanTitle(it.summary);
    card.appendChild(date); card.appendChild(title);
    if (it.description){ const d=document.createElement('div'); d.className='event-description'; d.textContent=stripLinks(it.description); card.appendChild(d); }
    c.appendChild(card);
  });
}

/* ===================== 2) S√Ñ√Ñ (Klaukkalan Mets√§kyl√§) ===================== */
const KL_PLACE = { name:'Klaukkalan Mets√§kyl√§', lat:60.372, lon:24.740 };
function wxIcon(code){
  const m={0:'‚òÄÔ∏è',1:'üå§Ô∏è',2:'‚õÖ',3:'‚òÅÔ∏è',45:'üå´Ô∏è',48:'üå´Ô∏è',51:'üå¶Ô∏è',53:'üå¶Ô∏è',55:'üå¶Ô∏è',61:'üåßÔ∏è',63:'üåßÔ∏è',65:'üåßÔ∏è',
           71:'‚ùÑÔ∏è',73:'‚ùÑÔ∏è',75:'‚ùÑÔ∏è',80:'üåßÔ∏è',81:'üåßÔ∏è',82:'üåßÔ∏è',95:'‚õàÔ∏è',96:'‚õàÔ∏è',99:'‚õàÔ∏è'}; return m[code]||'üå°Ô∏è';
}
async function loadWeather(){
  const card=document.getElementById('wx-card');
  const url=`https://api.open-meteo.com/v1/forecast?latitude=${KL_PLACE.lat}&longitude=${KL_PLACE.lon}&current=temperature_2m,weather_code,wind_speed_10m&hourly=precipitation&timezone=auto&_=${Date.now()}`;
  try{
    const r=await fetchWithTimeout(url, 12000);
    if(!r.ok) throw new Error('weather '+r.status);
    const d=await r.json();
    const t=Math.round(d?.current?.temperature_2m ?? NaN);
    const w=Math.round(d?.current?.wind_speed_10m ?? NaN);
    const rain=(d?.hourly?.precipitation?.[0] ?? 0);
    const code=d?.current?.weather_code ?? null;
    card.innerHTML=`
      <div class="w-city">${KL_PLACE.name}</div>
      <div class="w-temp">${isFinite(t)? t+'¬∞C':'‚Äì'} ${code!==null? `<span class="w-icon">${wxIcon(code)}</span>`:''}</div>
      <div class="w-row">
        <span class="w-badge">Tuuli ${isFinite(w)? w+' m/s':'‚Äì'}</span>
        <span class="w-badge">Sade ${rain?.toFixed ? rain.toFixed(1) : rain} mm</span>
        <span class="w-badge">Koodi ${code ?? '‚Äì'}</span>
      </div>`;
  }catch{
    card.innerHTML=`
      <div class="w-city">${KL_PLACE.name}</div>
      <div class="w-temp">‚Äì</div>
      <div class="w-row"><span class="w-badge">S√§√§ ei saatavilla</span></div>`;
  }
}

/* ===================== 3) FMI VAROITUKSET (CAP RSS) ===================== */
const FMI_RSS_FI = 'https://alerts.fmi.fi/cap/feed/rss_fi-FI.rss'; // avoin feed
function sevClassFromText(txt){
  const t=(txt||'').toLowerCase();
  if (t.includes('punainen')||t.includes('red')) return 'lvl-red';
  if (t.includes('oranssi')||t.includes('orange')) return 'lvl-orange';
  if (t.includes('keltainen')||t.includes('yellow')) return 'lvl-yellow';
  return '';
}
function warnItemHtml(w){
  return `<div class="warn-item ${w.level}">
    <div class="warn-icon">${w.level==='lvl-red'?'!':(w.level==='lvl-orange'?'!':'i')}</div>
    <div class="warn-content">
      <div class="w-title">${w.title}</div>
      ${w.when ? `<div class="w-when">${w.when}</div>`:''}
      ${w.desc ? `<div class="w-desc">${w.desc}</div>`:''}
    </div>
  </div>`;
}
async function loadWarnings(){
  const list = document.getElementById('warn-list');
  list.innerHTML = '<div class="warn-item"><div class="warn-content">Ladataan varoituksia‚Ä¶</div></div>';
  try{
    const url = PROXY + encodeURIComponent(FMI_RSS_FI) + '&_=' + Date.now(); // proxyll√§ v√§ltet√§√§n CORS
    const r = await fetchWithTimeout(url, 12000); if(!r.ok) throw new Error('FMI '+r.status);
    const xml = await r.text();
    const doc = new DOMParser().parseFromString(xml, 'text/xml');
    const items = Array.from(doc.querySelectorAll('item')).map(it=>{
      const title = it.querySelector('title')?.textContent?.trim() || 'Varoitus';
      const desc  = it.querySelector('description')?.textContent?.trim() || '';
      const pub   = it.querySelector('pubDate')?.textContent?.trim() || '';
      let when=''; try{ when = pub ? new Date(pub).toLocaleString('fi-FI') : '' }catch(_){}
      const level = sevClassFromText(title + ' ' + desc);
      return {title, desc, when, level};
    });

    const ku = items.filter(x => /Nurmij|Keski-?Uusimaa|Hyvink|J√§rvenp√§√§|Tuusula|Kerava|M√§nts√§l√§|Pornainen|Klaukkala/i.test(x.title + ' ' + x.desc)).slice(0,10);
    const fi = items.slice(0, 12);

    if (!ku.length && !fi.length){
      list.innerHTML = '<div class="warn-item"><div class="warn-content">Ei voimassa olevia varoituksia</div></div>';
      return;
    }
    let html = '';
    if (ku.length){
      html += `<div class="warn-item" style="background:#eef3f8"><div class="warn-content"><div class="w-title">Keski-Uusimaa</div></div></div>`;
      html += ku.map(warnItemHtml).join('');
    }
    if (fi.length){
      html += `<div class="warn-item" style="background:#eef3f8"><div class="warn-content"><div class="w-title">Koko Suomi</div></div></div>`;
      html += fi.map(warnItemHtml).join('');
    }
    list.innerHTML = html;
  }catch{
    list.innerHTML = '<div class="warn-item"><div class="warn-content">Varoituksia ei voitu hakea</div></div>';
  }
}

/* ===================== 4) DIGITRAFFIC (CORS ‚Üí proxy) ===================== */
async function loadTraffic(){
  const box = document.getElementById('traffic-list');
  box.innerHTML = '<div class="traffic-item"><div class="t-title">Ladataan liikennetietoja‚Ä¶</div></div>';
  try{
    const api = 'https://tie.digitraffic.fi/api/traffic-message/v1/messages?inactiveHours=0';
    const r = await fetchWithTimeout(PROXY + encodeURIComponent(api) + '&_=' + Date.now(), 12000);
    if(!r.ok) throw new Error('traffic '+r.status);
    const data = await r.json();

    let msgs = data?.trafficMessages || data?.features || data?.messages || [];
    if (Array.isArray(data?.features)) msgs = data.features.map(f => f.properties || f);

    const wanted = ['Helsinki','Vantaa','Espoo','Kauniainen','Nurmij√§rvi','Hyvink√§√§','J√§rvenp√§√§','Tuusula','Kerava','Sipoo','Kirkkonummi','Vihti','Klaukkala','Uusimaa','P√§√§kaupunkiseutu'];
    const inArea = (m) => {
      const s = (m?.title || m?.announcement || m?.location || m?.roadAddressRegion || '').toString();
      return wanted.some(w => s.toLowerCase().includes(w.toLowerCase()));
    };
    let list = msgs.filter(inArea);
    if (list.length < 8) list = msgs; // fallback

    const html = list.slice(0, 14).map(m=>{
      const title = m.title || m.announcement || 'Liikennetiedote';
      const time  = m?.releaseTime || m?.publicationTime || m?.eventTime || m?.lastUpdated || '';
      const when  = time ? new Date(time).toLocaleString('fi-FI') : '';
      const desc  = m?.description || m?.cause || '';
      const region= m?.roadAddressRegion || m?.location || '';
      return `<div class="traffic-item">
        <div class="t-title">${title}</div>
        <div class="t-meta">${region}${when ? ' ‚Ä¢ '+when : ''}</div>
        ${desc ? `<div class="t-desc">${desc}</div>` : ''}
      </div>`;
    }).join('');
    box.innerHTML = html || '<div class="traffic-item"><div class="t-title">Ei ajankohtaisia tiedotteita</div></div>';
  }catch{
    box.innerHTML = '<div class="traffic-item"><div class="t-title">Liikennetietoja ei voitu hakea</div></div>';
  }
}

/* ===================== INIT + P√ÑIVITYSSYKLI ===================== */
async function init(){
  const ev = await loadICS(ICS_URL());   renderEvents('miehisto-events', ev);
  await loadWeather();
  await loadWarnings();
  await loadTraffic();

  // P√§ivitykset (ei luuppia pys√§ytet√§ slidevaihdossa)
  setInterval(async ()=>{ const e=await loadICS(ICS_URL()); renderEvents('miehisto-events', e); }, 5*60*1000);
  setInterval(loadWeather,   10*60*1000);
  setInterval(loadWarnings,  10*60*1000);
  setInterval(loadTraffic,    5*60*1000);
}
init();
</script>
</body>
</html>
