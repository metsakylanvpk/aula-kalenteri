<!DOCTYPE html>
<html lang="fi">
<head>
<meta charset="UTF-8">
<title>Aulan kalenteri</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body {
  margin: 0;
  background: #f9f9f9;
  font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
  color: #222;
}

/* Yleinen container diaesitykselle */
.page {
  display: none;
  height: 100vh;
  width: 100%;
  padding: 20px;
  box-sizing: border-box;
}

/* Otsikot */
.header {
  font-size: 2em;
  padding: 12px 20px;
  font-weight: 700;
  color: #fff;
  border-radius: 12px 12px 0 0;
  margin-bottom: 15px;
}
.header.miehistö { background: #007b83; }
.header.saa      { background: #ff8114; }
.header.varoitus { background: #2178a1; }
.header.liikenne { background: #444; }

/* Kortit */
.card {
  background: #fff;
  border-radius: 10px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.15);
  padding: 15px;
  margin-bottom: 15px;
}

.card.inactive {
  background: #eee;
  color: #555;
}

.card h3 {
  margin: 0 0 8px 0;
  font-size: 1.2em;
}
.card .time {
  font-size: 0.9em;
  color: #666;
  margin-bottom: 6px;
}
</style>
</head>
<body>

<!-- Liikennetiedotteet -->
<div id="liikenne" class="page">
  <div class="header liikenne">Liikennetiedotteet (Keski-Uusimaa + Vantaa)</div>
  <div id="traffic-list"></div>
</div>

<script>
// Vaihdetaan dioja 20s välein
let currentPage = 0;
const pages = document.querySelectorAll('.page');
function showPage(i) {
  pages.forEach((p, idx) => p.style.display = (idx === i ? 'block' : 'none'));
}
function rotatePages() {
  showPage(currentPage);
  currentPage = (currentPage + 1) % pages.length;
}
setInterval(rotatePages, 20000);
rotatePages();

/* --- Liikennetiedotteet --- */
const TRAFFIC_PROXY = "https://vpk.mijuze1.workers.dev/?url=" +
  encodeURIComponent("https://tie.digitraffic.fi/api/traffic-message/v1/messages");

const ALLOWED_MUNICIPALITIES = [
  "Nurmijärvi","Järvenpää","Kerava","Tuusula","Hyvinkää",
  "Mäntsälä","Sipoo","Pornainen","Vantaa"
];

async function loadTraffic() {
  try {
    const res = await fetch(TRAFFIC_PROXY);
    const data = await res.json();
    const list = document.getElementById("traffic-list");
    list.innerHTML = "";

    const filtered = data.features.filter(item => {
      const muni = item.properties?.municipalityFI || "";
      return ALLOWED_MUNICIPALITIES.includes(muni);
    });

    if (!filtered.length) {
      list.innerHTML = "<div class='card'>Ei liikennetiedotteita alueella</div>";
      return;
    }

    filtered.forEach(item => {
      const p = item.properties;
      const start = new Date(p.announcementTime).toLocaleString("fi-FI");
      const end   = p.situationEnded ? new Date(p.situationEnded).toLocaleString("fi-FI") : null;

      const card = document.createElement("div");
      card.className = "card" + (p.status !== "ACTIVE" ? " inactive" : "");
      
      card.innerHTML = `
        <h3>${p.titleFI || "Liikennetiedote"}</h3>
        <div class="time">Alkanut: ${start}${end ? "<br>Päättynyt: " + end : ""}</div>
        <div>${p.commentsFI || ""}</div>
        <div><em>Kunta: ${p.municipalityFI || "?"}</em></div>
        ${p.status !== "ACTIVE" ? "<strong>Tilanne ohi</strong>" : ""}
      `;
      list.appendChild(card);
    });
  } catch (e) {
    console.error("Traffic error", e);
    document.getElementById("traffic-list").innerHTML =
      "<div class='card'>Liikennetietoja ei voitu hakea</div>";
  }
}

loadTraffic();
// Päivitetään 5 min välein
setInterval(loadTraffic, 5 * 60 * 1000);
</script>

</body>
</html>
