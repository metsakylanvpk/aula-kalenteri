<!DOCTYPE html>
<html lang="fi">
<head>
<meta charset="UTF-8">
<title>Aulan kalenterit</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body {
margin: 0;
background: linear-gradient(135deg, #f9f9f9, #e9eef3);
font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
min-height: 100vh;
display: flex;
justify-content: center;
padding: 20px;
}

.container {
display: flex;
flex-direction: column;
width: 95%;
max-width: 1366px;
gap: 20px;
}

.top-container {
display: flex;
gap: 20px;
flex-wrap: wrap;
}

.calendar-box {
flex: 1;
display: flex;
flex-direction: column;
background: #fff;
border-radius: 16px;
box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
overflow: hidden;
}

.header {
text-align: center;
font-size: 1.6em;
padding: 12px;
font-weight: 600;
letter-spacing: 1px;
color: #fff;
}

.header.miehistö { background: #007b83; }
.header.nuoriso { background: #ff8114; }

.events-list {
padding: 10px;
background: #e6f2f5;
max-height: 500px;
overflow-y: auto;
}

.event-card {
display: flex;
flex-direction: column;
border-radius: 8px;
margin-bottom: 10px;
padding: 10px;
box-shadow: 0 2px 6px rgba(0,0,0,0.1);
transition: transform 0.2s;
background: #fefefe;
}

.event-card:hover {
transform: scale(1.02);
box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

.event-date {
font-weight: bold;
margin-bottom: 4px;
font-size: 1em;
color: #fff;              /* Teksti valkoiseksi */
padding: 4px 6px;         /* Pieni sisämarginaali */
border-radius: 6px;       /* Pyöristetyt kulmat */
display: inline-block;    /* Näyttää "tägiltä" */
}

.event-title {
font-weight: bold;
word-wrap: break-word;
}

.event-description {
font-size: 0.9em;
color: #555;
margin-top: 4px;
word-wrap: break-word;
}

.bottom-container {
display: flex;
gap: 20px;
flex-wrap: wrap;
}

.bottom-container .calendar-box iframe {
height: 250px;
width: 100%;
border: none;
}

@media (max-width: 1024px) {
.top-container, .bottom-container { flex-direction: column; }
.events-list { max-height: 400px; }
.bottom-container .calendar-box iframe { height: 200px; }
}

@media (max-width: 600px) {
.header { font-size: 1.4em; padding: 10px; }
.events-list { max-height: 300px; }
.bottom-container .calendar-box iframe { height: 150px; }
}
</style>
</head>
<body>

<div class="container">

<div class="top-container">

<div class="calendar-box">
<div class="header miehistö">Miehistö</div>
<div class="events-list" id="miehisto-events"></div>
</div>

<div class="calendar-box">
<div class="header nuoriso">Nuoriso-osasto</div>
<div class="events-list" id="nuoriso-events"></div>
</div>

</div>

<div class="bottom-container">

<div class="calendar-box">
<div class="header miehistö">Miehistö Kalenteri</div>
<iframe src="https://metsakylanvpk.nimenhuuto.com/calendar/widget_iframe_monthly_calendar?css=&height=300&width=650"></iframe>
</div>

<div class="calendar-box">
<div class="header nuoriso">Nuoriso-osasto Kalenteri</div>
<iframe src="https://metsakylanvpknuoriso-osasto.nimenhuuto.com/calendar/widget_iframe_monthly_calendar?css=&height=300&width=650"></iframe>
</div>

</div>

</div>

<script>
const API_KEY = 'AIzaSyBh7OYl9olkOsbOICvDdTgmMYa9eiraDAs';
const MIEHISTO_CALENDAR_ID = '6fdpm0662hoerp1shdfdjskdbbei1dfe@import.calendar.google.com';
const NUORISO_CALENDAR_ID = 'pfibgctlru8apgqvhrhcq1jbnod644un@import.calendar.google.com';

function cleanTitle(title) {
// Poistaa kaiken ennen viimeistä erottajaa (– tai :)
const match = title.match(/(?:–|:)\s*(.+)$/);
if (match && match[1]) return match[1].trim();
return title.trim(); // jos ei erottajaa, palautetaan koko nimi
}

function getDateColor(originalTitle) {
  const t = originalTitle.toLowerCase().trim();
  
  // Kalustoesittely = vihreä
  if (t.includes("kalustoesittely")) return "#4CAF50";
  
  // Harjoitus = sininen
function getDateColor(title) {
  const t = title.toLowerCase().trim();
if (t.includes("harkka") || t.includes("harjoitus")) return "#007b83";
  
  // Turnaus/Kilpailu/Tapahtuma = oranssi
  if (t.includes("turnaus") || t.includes("kilpailu") || t.includes("tapahtuma")) return "#FF9800";
  
  // Juhla/Muu = punainen
  if (t.includes("juhla") || t.includes("muu")) return "#F44336";
  
  // Myrskyvauriot = tummanharmaa
  if (t.includes("myrskyvauriot")) return "#555";
  
  // Oletusväri
  return "#888";
  if (t.includes("turnaus") || t.includes("kilpailu") || t.includes("tapahtuma")) return "#4CAF50";
  if (t.includes("juhla") || t.includes("muu")) return "#FF9800";
  return "#555";
}

function stripLinks(html) {
  if (!html) return '';
const div = document.createElement('div');
div.innerHTML = html;
div.querySelectorAll('a').forEach(a => a.remove());
let text = div.textContent || div.innerText || "";
text = text.replace(/https?:\/\/[^\s]+/g, '');
return text;
}

function formatEventDate(startStr, endStr) {
const start = startStr.includes('T') ? new Date(startStr) : new Date(startStr);
const end = endStr.includes('T') ? new Date(endStr) : new Date(endStr);

const sameDay = start.toDateString() === end.toDateString();
const isAllDay = !startStr.includes('T') && !endStr.includes('T');

if (isAllDay) {
if (sameDay) return start.toLocaleDateString('fi-FI');
else return `${start.toLocaleDateString('fi-FI')} – ${end.toLocaleDateString('fi-FI')}`;
} else if (sameDay) {
return `${start.toLocaleDateString('fi-FI')} klo ${start.toLocaleTimeString('fi-FI',{hour:'2-digit',minute:'2-digit'})} – ${end.toLocaleTimeString('fi-FI',{hour:'2-digit',minute:'2-digit'})}`;
} else {
return `${start.toLocaleDateString('fi-FI')} klo ${start.toLocaleTimeString('fi-FI',{hour:'2-digit',minute:'2-digit'})} – ${end.toLocaleDateString('fi-FI')} klo ${end.toLocaleTimeString('fi-FI',{hour:'2-digit',minute:'2-digit'})}`;
}
}

function fetchEvents(calendarId) {
const now = new Date().toISOString();
const url = `https://www.googleapis.com/calendar/v3/calendars/${calendarId}/events?key=${API_KEY}&timeMin=${now}&orderBy=startTime&singleEvents=true&maxResults=20`;
return fetch(url).then(res => res.json());
}

function renderEvent(containerId, events) {
const container = document.getElementById(containerId);
  if (!container) return;
  
container.innerHTML = '';
  
  if (!events || events.length === 0) {
    container.innerHTML = '<div class="event-card"><div class="event-title">Ei tulevia tapahtumia</div></div>';
    return;
  }
  
events.forEach(item => {
const start = item.start.dateTime || item.start.date;
const end = item.end.dateTime || item.end.date;
    const originalTitle = item.summary || 'Nimetön tapahtuma';
    const cleanTitleText = cleanTitle(originalTitle);
    const dateColor = getDateColor(originalTitle); // Käytetään alkuperäistä nimeä värien määrittelyyn
    const title = cleanTitle(item.summary);
    const dateColor = getDateColor(title);
const description = item.description ? stripLinks(item.description) : '';
    
const html = `
     <div class="event-card">
       <div class="event-date" style="background:${dateColor}">${formatEventDate(start, end)}</div>
        <div class="event-title">${cleanTitleText}</div>
        <div class="event-title">${title}</div>
       ${description ? `<div class="event-description">${description}</div>` : ''}
     </div>`;
container.innerHTML += html;
});
}

// Ladataan tapahtumat ja renderöidään ne
Promise.all([
  fetchEvents(MIEHISTO_CALENDAR_ID).then(data => renderEvent('miehisto-events', data.items)),
  fetchEvents(NUORISO_CALENDAR_ID).then(data => renderEvent('nuoriso-events', data.items))
]).catch(error => {
  console.error('Virhe tapahtumien haussa:', error);
  document.getElementById('miehisto-events').innerHTML = '<div class="event-card"><div class="event-title">Virhe tapahtumien latauksessa</div></div>';
  document.getElementById('nuoriso-events').innerHTML = '<div class="event-card"><div class="event-title">Virhe tapahtumien latauksessa</div></div>';
});

// Päivitetään sivua 15 minuutin välein
fetchEvents(MIEHISTO_CALENDAR_ID).then(data => renderEvent('miehisto-events', data.items));
fetchEvents(NUORISO_CALENDAR_ID).then(data => renderEvent('nuoriso-events', data.items));

setTimeout(() => location.reload(), 15 * 60 * 1000);
</script>

</body>
</html><!DOCTYPE html>
<html lang="fi">
<head>
  <meta charset="UTF-8" />
  <title>Tapahtumat</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f7f7f7;
      padding: 20px;
    }
    h1 {
      text-align: center;
    }
    .container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 15px;
    }
    .card {
      background: white;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .date {
      font-weight: bold;
      margin-bottom: 5px;
    }
    .summary {
      font-size: 1.1em;
      margin-bottom: 8px;
    }
    .description {
      font-size: 0.9em;
      color: #555;
    }

    /* Värikoodaus tapahtumatyypin mukaan */
    .harkka .date {
      color: #2c6d7d; /* sinertävä */
    }
    .auto .date {
      color: #d2691e; /* oranssi */
    }
    .kalusto .date {
      color: #4b6f28; /* vihreä */
    }
    .muu .date {
      color: #8b8000; /* keltaruskea */
    }
    .ei .date {
      color: #468080; /* harmaa/turkoosi */
    }
  </style>
</head>
<body>
  <h1>Tapahtumat</h1>
  <div class="container" id="events"></div>

  <script src="https://cdn.jsdelivr.net/npm/ical.js@1.4.0/build/ical.min.js"></script>
  <script>
    const urls = [
      "https://metsakylanvpk.nimenhuuto.com/calendar/ical",
      "https://metsakylanvpknuoriso-osasto.nimenhuuto.com/calendar/ical"
    ];

    async function loadCalendar(url) {
      const response = await fetch(url);
      const text = await response.text();
      const jcalData = ICAL.parse(text);
      const comp = new ICAL.Component(jcalData);
      return comp.getAllSubcomponents("vevent").map(vevent => new ICAL.Event(vevent));
    }

    function formatDate(start, end) {
      const options = { day: "numeric", month: "numeric", year: "numeric" };
      const timeOptions = { hour: "2-digit", minute: "2-digit" };

      const sameDay = start.toJSDate().toDateString() === end.toJSDate().toDateString();

      if (sameDay) {
        return `${start.toJSDate().toLocaleDateString("fi-FI", options)} klo ${start.toJSDate().toLocaleTimeString("fi-FI", timeOptions)} - ${end.toJSDate().toLocaleTimeString("fi-FI", timeOptions)}`;
      } else {
        return `${start.toJSDate().toLocaleDateString("fi-FI", options)} ${start.toJSDate().toLocaleTimeString("fi-FI", timeOptions)} – ${end.toJSDate().toLocaleDateString("fi-FI", options)} ${end.toJSDate().toLocaleTimeString("fi-FI", timeOptions)}`;
      }
    }

    function getEventClass(summary) {
      summary = summary.toLowerCase();
      if (summary.includes("harkka")) return "harkka";
      if (summary.includes("auto")) return "auto";
      if (summary.includes("kalusto")) return "kalusto";
      if (summary.includes("muu")) return "muu";
      if (summary.includes("ei käytössä")) return "ei";
      return "";
    }

    async function displayEvents() {
      let events = [];
      for (let url of urls) {
        const evs = await loadCalendar(url);
        events = events.concat(evs);
      }

      events.sort((a, b) => a.startDate.toJSDate() - b.startDate.toJSDate());

      const container = document.getElementById("events");
      events.forEach(event => {
        const card = document.createElement("div");
        card.className = "card " + getEventClass(event.summary);

        const date = document.createElement("div");
        date.className = "date";
        date.textContent = formatDate(event.startDate, event.endDate);

        const summary = document.createElement("div");
        summary.className = "summary";
        summary.textContent = event.summary
          .replace("Metsäkylän VPK:", "")
          .replace("Nuoriso-osasto:", "")
          .trim();

        const description = document.createElement("div");
        description.className = "description";
        description.textContent = event.description.replace(/https?:\/\/\S+/g, "").trim();

        card.appendChild(date);
        card.appendChild(summary);
        if (description.textContent) card.appendChild(description);

        container.appendChild(card);
      });
    }

    displayEvents();
  </script>
</body>
</html>

