<!DOCTYPE html>
<html lang="fi">
<head>
<meta charset="UTF-8">
<title>Miehistön Tapahtumat + Sää</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
/* sama tyyli kuin edellisessä, lyhennettynä vain muutokset näkyviin */
body { margin:0; background:#e9eef3; font-family:"Segoe UI",sans-serif; }
.container { width:100vw; height:100vh; display:flex; flex-direction:column; padding:8px; }
.calendar-box { flex:1; display:flex; flex-direction:column; background:#fff; border-radius:12px;
  box-shadow:0 3px 12px rgba(0,0,0,.15); overflow:hidden; }
.header { height:60px; display:flex; align-items:center; justify-content:center;
  background:#007b83; color:#fff; font-size:1.6rem; font-weight:700; }
.content { flex:1; position:relative; background:#e6f2f5; }
.view { position:absolute; inset:0; padding:12px; box-sizing:border-box; }
.view.hidden { display:none; }
.event-card{ background:#fff; border-radius:8px; padding:16px; margin-bottom:10px;
  box-shadow:0 2px 6px rgba(0,0,0,.1); }
.event-date{ font-weight:bold; color:#fff; padding:4px 8px; border-radius:6px; margin-bottom:6px; display:inline-block;}
.event-title{ font-weight:700; font-size:1.3rem;}
.event-description{ font-size:1.1rem; color:#333; margin-top:6px;}
.muted{opacity:.7;font-style:italic;}
/* mobiilille sallitaan scroll */
@media (max-width:1024px){ body{overflow:auto} }
</style>
</head>
<body>
<div class="container">
  <div class="calendar-box">
    <div class="header" id="view-title">Miehistön Tapahtumat</div>
    <div class="content">
      <section class="view events" id="view-events">
        <div class="events-list" id="miehisto-events">
          <div class="event-card muted">Ladataan tapahtumia…</div>
        </div>
      </section>
      <section class="view weather hidden" id="view-weather">
        <div id="wx-content">Ladataan säätietoja…</div>
      </section>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/ical.js@1.4.0/build/ical.min.js"></script>
<script>
/* === ASETUKSET === */
const PROXY = 'https://vpk.mijuze1.workers.dev/?url=';
const MIEHISTO_ICS_URL = PROXY + encodeURIComponent('https://metsakylanvpk.nimenhuuto.com/calendar/ical');
const LAT = 60.4646, LON = 24.8071; // Nurmijärvi
const SWITCH_MS = 20000;

/* === TAPAHTUMAT === */
async function loadICS(url){
  try {
    const res = await fetch(url,{cache:"no-store"});
    if(!res.ok) throw new Error("ICS fetch fail "+res.status);
    const text = await res.text();
    const jcal = ICAL.parse(text);
    const comp = new ICAL.Component(jcal);
    const events = comp.getAllSubcomponents("vevent").map(ve=>new ICAL.Event(ve));
    const now = new Date();
    return events.filter(ev=>ev.endDate && ev.endDate.toJSDate()>now)
      .map(ev=>({
        summary: ev.summary,
        description: ev.description,
        startDate: ev.startDate.toJSDate(),
        endDate: ev.endDate.toJSDate(),
        allDay: ev.startDate.isDate && ev.endDate.isDate
      }))
      .sort((a,b)=>a.startDate-b.startDate);
  } catch(e){
    console.error("ICS error",e);
    return [];
  }
}
function renderEvents(containerId, items){
  const c=document.getElementById(containerId);
  c.innerHTML="";
  if(!items.length){
    c.innerHTML='<div class="event-card"><div class="event-title">Ei tapahtumia tai lataus epäonnistui</div></div>';
    return;
  }
  items.slice(0,5).forEach(it=>{
    const card=document.createElement("div");card.className="event-card";
    const date=document.createElement("div");date.className="event-date";date.style.background="#2178a1";
    date.textContent=new Date(it.startDate).toLocaleString("fi-FI");
    const t=document.createElement("div");t.className="event-title";t.textContent=it.summary;
    card.appendChild(date);card.appendChild(t);
    if(it.description){const d=document.createElement("div");d.className="event-description";d.textContent=it.description;card.appendChild(d);}
    c.appendChild(card);
  });
}

/* === SÄÄ === */
async function loadWeather(lat,lon){
  try{
    const url=`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,weather_code,wind_speed_10m&timezone=auto`;
    const res=await fetch(url);const data=await res.json();
    return data;
  }catch(e){console.error("Weather error",e);return null;}
}
function renderWeather(data){
  const box=document.getElementById("wx-content");
  if(!data){box.textContent="Säätietojen haku epäonnistui";return;}
  const c=data.current;
  box.innerHTML=`<h2>${Math.round(c.temperature_2m)}°C</h2><div>Tuuli: ${c.wind_speed_10m} m/s</div>`;
}

/* === NÄKYMÄN VAIHTO === */
let showingWeather=false;
function showView(which){
  document.getElementById("view-events").classList.toggle("hidden",which!=="events");
  document.getElementById("view-weather").classList.toggle("hidden",which!=="weather");
  document.getElementById("view-title").textContent=(which==="events"?"Miehistön Tapahtumat":"Sää & Varoitukset");
  showingWeather=(which==="weather");
}
function startSwitcher(){setInterval(()=>showView(showingWeather?"events":"weather"),SWITCH_MS);}

/* === INIT === */
async function init(){
  const ev=await loadICS(MIEHISTO_ICS_URL);renderEvents("miehisto-events",ev);
  const wx=await loadWeather(LAT,LON);renderWeather(wx);
  showView("events");startSwitcher();
}
init();
</script>
</body>
</html>
